name: Release

on:
  push:
    branches:
      - main

jobs:
  plan-release:
    if: "!contains(github.event.head_commit.message, '[skip ci]') || contains(github.event.head_commit.message, 'chore(release):')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      bump: ${{ steps.bump.outputs.bump }}
      is_release: ${{ steps.bump.outputs.is_release }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Determine release type
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const shas = new Set([context.sha]);
            const commits = context.payload.commits ?? [];
            for (const commit of commits) {
              if (commit?.id) shas.add(commit.id);
            }

            const labels = [];
            const prNumbers = new Set();

            for (const sha of shas) {
              try {
                const { data } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner,
                  repo,
                  commit_sha: sha,
                  mediaType: { previews: ['groot'] },
                });

                for (const pr of data) {
                  prNumbers.add(pr.number);
                  for (const label of pr.labels) {
                    labels.push(label.name);
                  }
                }
              } catch (error) {
                core.warning(`Failed to load PR labels for ${sha}: ${error.message}`);
              }
            }

            const normalized = labels.map((label) => String(label).toLowerCase());
            const isRelease = normalized.includes('release');
            let bump = 'patch';

            if (normalized.includes('major')) {
              bump = 'major';
            } else if (normalized.includes('minor')) {
              bump = 'minor';
            } else if (normalized.includes('patch')) {
              bump = 'patch';
            } else if (!normalized.length) {
              core.warning('No PR labels found; defaulting to patch release.');
            }

            if (prNumbers.size) {
              core.info(`Associated PR(s): ${Array.from(prNumbers).join(', ')}`);
            }

            core.info(`Release type: ${bump}`);
            core.setOutput('bump', bump);
            core.setOutput('is_release', isRelease ? 'true' : 'false');

      - name: Verify npm access
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          NPM_USER="$(npm whoami)"
          export NPM_USER
          echo "NPM user: ${NPM_USER}"
          echo "Package: ${PACKAGE_NAME}"

          if npm view "${PACKAGE_NAME}" --json > /tmp/npm-package.json 2>/dev/null; then
            node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('/tmp/npm-package.json','utf8')); const user=process.env.NPM_USER; const maintainers=(data.maintainers||[]).map((entry)=>typeof entry==='string'?entry:entry.name).filter(Boolean); const hasAccess=maintainers.some((entry)=>entry===user||entry.startsWith(user+' ')); if(!hasAccess){console.error('NPM user \"'+user+'\" is not a maintainer for '+data.name+'.'); console.error('Add this user as a collaborator on npm or change the package name.'); process.exit(1);} console.log('NPM user \"'+user+'\" has publish access for '+data.name+'.');"
          else
            echo "Package not found on npm; proceeding with first publish."
          fi

  prepare-release-pr:
    needs: plan-release
    if: needs.plan-release.outputs.is_release != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare release commit
        env:
          RELEASE_TYPE: ${{ needs.plan-release.outputs.bump }}
        run: |
          set -euo pipefail
          CURRENT_VERSION="$(node -p "require('./package.json').version")"
          NEXT_VERSION="$(node -e "const [maj,min,pat]=process.argv[1].split('.').map(Number); const bump=process.argv[2]; let v; if(bump==='major'){v=[maj+1,0,0];} else if(bump==='minor'){v=[maj,min+1,0];} else {v=[maj,min,pat+1];} console.log(v.join('.'));" "${CURRENT_VERSION}" "${RELEASE_TYPE}")"
          git fetch origin "refs/heads/release/*:refs/remotes/origin/release/*" || true
          if git show-ref --quiet "refs/remotes/origin/release/v${NEXT_VERSION}"; then
            git checkout -B "release/v${NEXT_VERSION}" "origin/release/v${NEXT_VERSION}"
          else
            git checkout -b "release/v${NEXT_VERSION}"
          fi
          git reset --hard
          CURRENT_VERSION="$(node -p "require('./package.json').version")"
          if [ "${CURRENT_VERSION}" != "${NEXT_VERSION}" ]; then
            npm version "${NEXT_VERSION}" --no-git-tag-version
          fi
          npx auto-changelog -p
          git add package.json package-lock.json CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No release changes to commit."
          else
            git commit -m "chore(release): v${NEXT_VERSION} [skip ci]"
          fi
          git push -u origin "release/v${NEXT_VERSION}"
          echo "next_version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Ensure release label exists
        run: |
          echo "Release label is expected to exist."

      - name: Open release PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_RELEASE || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          NEXT_VERSION="$(node -p "require('./package.json').version")"
          PR_URL=$(gh pr create --title "chore(release): v${NEXT_VERSION}" --body "Automated release PR for v${NEXT_VERSION}." --base main --head "release/v${NEXT_VERSION}" --label "release" || gh pr view "release/v${NEXT_VERSION}" --json url -q .url)
          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"

      - name: Wait for release PR checks
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_RELEASE }}
        run: |
          set -euo pipefail
          PR_URL="${{ steps.pr.outputs.pr_url }}"
          if OUTPUT=$(gh pr checks "${PR_URL}" --watch --interval 10 2>&1); then
            echo "${OUTPUT}"
            exit 0
          fi
          if echo "${OUTPUT}" | grep -qi "no checks reported"; then
            echo "No checks reported for ${PR_URL}. Continuing without waiting."
            exit 0
          fi
          echo "${OUTPUT}" >&2
          exit 1

      - name: Merge release PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_RELEASE }}
        run: |
          set -euo pipefail
          gh pr merge --merge --delete-branch "${{ steps.pr.outputs.pr_url }}"

  publish-release:
    needs: plan-release
    if: needs.plan-release.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build and test
        run: |
          npm run lint
          npm run build
          npm run test

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          VERSION="$(node -p "require('./package.json').version")"
          if npm view "${PACKAGE_NAME}@${VERSION}" --json > /dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${VERSION} already published."
            exit 0
          fi
          npm publish --ignore-scripts

      - name: Tag and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./package.json').version")"
          if git rev-parse "${VERSION}" >/dev/null 2>&1; then
            echo "Tag ${VERSION} already exists."
          else
            git tag "${VERSION}"
            git push origin "${VERSION}"
          fi
          if gh release view "${VERSION}" >/dev/null 2>&1; then
            echo "GitHub release ${VERSION} already exists."
          else
            gh release create "${VERSION}" --generate-notes
          fi
